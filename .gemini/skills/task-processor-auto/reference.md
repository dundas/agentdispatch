# Autonomous Task Processor - Reference

## Purpose
Process task lists autonomously with automated PR reviews and gap analysis after each phase completion.

## Key Differences from Standard task-processor
1. **No User Pauses:** Works through all sub-tasks autonomously
2. **Automated PR Review:** Checks PR status, CI, and generates gap analysis
3. **Detailed PR Comments:** Automatically adds comprehensive change summaries
4. **Gap Analysis Documents:** Creates formal gap analysis for each PR

## Workflow Phases

### 1. Implementation Phase
- Process all sub-tasks sequentially
- Commit after each sub-task
- Run tests continuously
- No user approval needed between tasks

### 2. PR Creation Phase
- Push branch after parent task complete
- Create PR with detailed description
- Include implementation summary, testing results, files changed

### 3. Automated Review Phase
- Check PR status via `gh pr view`
- Check CI status via `gh pr checks`
- Fetch review comments via GitHub API
- Generate gap analysis document
- Push gap analysis to repo

### 4. PR Comment Phase
- Create detailed comment with:
  - Files changed with descriptions
  - Implementation details
  - Testing results
  - Link to gap analysis
- Post via `gh pr comment`

### 5. Iteration Phase (if needed)
- If gap analysis shows issues → fix → push → re-analyze
- Continue until "Ready to merge"

## Gap Analysis Template

```markdown
# PR #[number] Gap Analysis

**Date:** YYYY-MM-DD
**PR:** #[number] - [Title]
**Status:** [Ready to Merge / Needs Work]

---

## Current State

### Changes Summary
- **Files Changed:** X files
- **Lines Added:** +Y
- **Lines Removed:** -Z
- **Tests Added:** N tests (M assertions)

### CI Status
- Build: Passing
- Tests: 250/250 passing
- Lint: No errors
- Coverage: 85% (target: 90%)

### Review Comments
- **Total Comments:** X
- **Blocking:** Y
- **Non-blocking:** Z

---

## Gap to "Ready to Merge"

### Completed Requirements
- [x] All sub-tasks implemented
- [x] Unit tests added (50+ assertions)
- [x] Integration tests passing
- [x] Documentation updated

### Critical Issues (Blockers)
- [ ] Coverage below 90% (currently 85%)
- [ ] Review comment: Add error handling in function X

### Important Issues (Should Fix)
- [ ] Review comment: Consider refactoring function Y
- [ ] Minor linting warnings

### Nice to Have (Optional)
- [ ] Add more edge case tests
- [ ] Improve inline documentation

---

## Recommendation

**Overall Assessment:** [Ready / Needs Work / Almost Ready]

**Action Items:**
1. Fix critical issue 1
2. Fix critical issue 2
3. (Optional) Address nice-to-haves

**Fix Complexity:** [trivial/small/medium/large]

---

## Review Milestones
- Created: YYYY-MM-DD HH:MM
- First Review: YYYY-MM-DD HH:MM
- Gap Analysis: YYYY-MM-DD HH:MM
- Ready to Merge: [TBD / YYYY-MM-DD HH:MM]

---

*Gap analysis generated by task-processor-auto skill*
```

## PR Comment Template

```markdown
## Changes Summary

### Files Modified
- `src/agents/comparison/ranker.ts` - Implemented global ranking algorithm
- `src/agents/comparison/normalizer.ts` - Added score normalization (0-100 scale)
- `src/agents/comparison/types.ts` - TypeScript type definitions
- `src/agents/comparison/__tests__/ranker.test.ts` - 20 test cases added
- `src/agents/comparison/__tests__/normalizer.test.ts` - 15 test cases added
- `src/core/discovery/engine.ts` - Extended for multi-strategy scanning

**Total:** 6 files changed (+450/-12 lines)

---

### Implementation Details

**1. Multi-Strategy Scanning**
- Extended discovery engine to run scans for covered calls, puts, collars, spreads simultaneously
- Added `scanAllStrategyTypes()` method with parallel execution
- Implemented strategy-type filtering in results

**2. Score Normalization**
- Created `normalizeScore()` function using min-max normalization
- Ensures all strategy scores comparable on 0-100 scale
- Handles edge cases (single strategy, tied scores)

**3. Global Ranking**
- Implemented `rankOpportunities()` with configurable sort criteria
- Added reasoning generation: explains why A ranked above B
- Supports optional strategy-type weights

---

### Testing

- **Unit Tests:** 50/50 passing (35 new + 15 updated)
- **Integration Tests:** 5/5 passing
- **Code Coverage:** 92% (target: 90%)
- **Performance:** Ranking 100 opportunities takes <50ms

**Test Highlights:**
- Edge case: Single strategy in comparison
- Edge case: All strategies tied scores
- Integration: Compare 4 strategy types simultaneously
- Property-based: 100 random scenarios validated

---

### Gap Analysis

See **[docs/PR_[N]_GAP_ANALYSIS.md](./docs/PR_[N]_GAP_ANALYSIS.md)** for detailed gap analysis.

**Quick Summary:**
- All sub-tasks completed
- Tests passing
- No blocking issues
- 1 minor enhancement suggested

---

### Task Reference

Implements tasks from `tasks/[task-file].md`:
- [x] 1.1 Extend discovery engine for multi-strategy scanning
- [x] 1.2 Create score normalization module
- [x] 1.3 Build global ranking algorithm
- [x] 1.4 Add comparison reasoning generation
- [x] 1.5 Create TypeScript types
- [x] 1.6 Integration test: Compare 4 strategy types
- [x] 1.7 Create PR (this PR)

---

### Status

**Ready for Review**

All requirements met. No blocking issues. Minor enhancement optional.

---

*Comment generated by task-processor-auto skill*
```

## GitHub CLI Commands Reference

### Check PR Status
```bash
gh pr view 16
```

### Check CI Status
```bash
gh pr checks 16
```

### Get Review Comments
```bash
gh api repos/OWNER/REPO/pulls/16/comments
```

### Add PR Comment
```bash
gh pr comment 16 --body "$(cat comment.md)"
```

### Get PR File Changes
```bash
gh pr diff 16
```

## Automation Tips

1. **Wait for CI:** Add 30-60 second delay after PR creation before checking status (adjust per repo)
2. **Poll CI Status:** Check every 10 seconds until complete
3. **Parse Review Comments:** Extract actionable items from JSON response
4. **Idempotent Gap Analysis:** Overwrite previous gap analysis file
5. **Comment Threading:** Use `gh pr comment` to add new comments vs editing

## Error Handling

- If CI fails → Include failure details in gap analysis
- If review has blocking comments → Mark as "Needs Work" in gap analysis
- If GitHub API fails → Generate gap analysis from local state
- If PR creation fails → Check if PR already exists for branch

## Integration with Task List

- Update task list after each commit
- Mark parent task complete only after PR created
- Add gap analysis link to task notes
- Track PR number in task list

## Example Session

```bash
# Start autonomous processing
skill: task-processor-auto

# Agent processes tasks 1.1 through 1.7
# ... implementation happens ...

# After task 1.7 complete:
git push -u origin feat/phase-1-comparison
gh pr create --title "Phase 1: Multi-Strategy Comparison & Ranking" --body "..."

# Wait for CI
sleep 30

# Check status
gh pr view 16 > /tmp/pr-status.txt
gh pr checks 16 > /tmp/ci-status.txt

# Generate gap analysis
# ... create docs/PR_16_GAP_ANALYSIS.md ...

# Push gap analysis
git add docs/PR_16_GAP_ANALYSIS.md
git commit -m "docs: add PR 16 gap analysis"
git push

# Add detailed comment
gh pr comment 16 --body "$(cat /tmp/pr-comment.md)"

# Mark task 1.0 complete
# Update tasks/[task-file].md with [x]

# Move to task 2.0
```

---

*Reference document for autonomous task processor skill*
